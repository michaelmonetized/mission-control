#!/usr/bin/env bash
# mc-run - Start/stop dev server in background
# Usage: mc-run <project-path>

set -e

# Validate arguments
if [[ -z "${1:-}" ]]; then
  echo "Usage: mc-run <project-path>" >&2
  exit 1
fi

PROJECT_PATH="$1"

if [[ ! -d "$PROJECT_PATH" ]]; then
  echo "Error: Directory does not exist: $PROJECT_PATH" >&2
  exit 1
fi

PROJECT=$(basename "$PROJECT_PATH")
PID_DIR="$HOME/.hustlemc/pids"
LOG_DIR="$HOME/.hustlemc/logs"
PID_FILE="$PID_DIR/$PROJECT.pid"
LOG_FILE="$LOG_DIR/$PROJECT.log"

mkdir -p "$PID_DIR" "$LOG_DIR"

cd "$PROJECT_PATH"

# Check if already running
if [[ -f "$PID_FILE" ]]; then
  PID=$(cat "$PID_FILE")
  if kill -0 "$PID" 2>/dev/null; then
    # Stop it
    kill "$PID" 2>/dev/null || true
    rm -f "$PID_FILE"
    osascript -e "display notification \"Dev server stopped\" with title \"$PROJECT\"" 2>/dev/null || true
    echo "Stopped dev server (PID $PID)"
    exit 0
  else
    rm -f "$PID_FILE"
  fi
fi

# Detect package manager and start dev server
# Check for bun (supports both bun.lockb and bun.lock)
if [[ -f "bun.lockb" ]] || [[ -f "bun.lock" ]] || [[ -f "bunfig.toml" ]]; then
  CMD="bun run dev"
elif [[ -f "pnpm-lock.yaml" ]]; then
  CMD="pnpm run dev"
elif [[ -f "yarn.lock" ]]; then
  CMD="yarn dev"
else
  CMD="npm run dev"
fi

# Verify dev script exists in package.json
if [[ -f "package.json" ]]; then
  if ! grep -q '"dev"' package.json 2>/dev/null; then
    echo "Warning: No 'dev' script found in package.json" >&2
  fi
fi

# Start server directly (not in subshell) so $! captures actual PID
$CMD > "$LOG_FILE" 2>&1 &
SERVER_PID=$!
echo "$SERVER_PID" > "$PID_FILE"
disown "$SERVER_PID"

osascript -e "display notification \"Dev server started\" with title \"$PROJECT\"" 2>/dev/null || true
echo "Started dev server (PID $SERVER_PID)"
echo "Logs: $LOG_FILE"
