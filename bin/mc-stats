#!/usr/bin/env bash
# mc-stats - Aggregate stats for Mission Control status lines
# Usage: mc-stats [--json]
# Output: Aggregated counts for all projects

set -uo pipefail

OUTPUT_JSON=false
[[ "${1:-}" == "--json" ]] && OUTPUT_JSON=true

CACHE_DIR="$HOME/.hustlemc"
PROJECTS_CACHE="$CACHE_DIR/projects.json"
BIN_DIR="$(dirname "$0")"

# Ensure cache exists
if [[ ! -f "$PROJECTS_CACHE" ]]; then
  "$BIN_DIR/mc-discover" "$HOME/Projects" --json > "$PROJECTS_CACHE"
fi

projects=$(cat "$PROJECTS_CACHE")

# Initialize counters
total_projects=$(echo "$projects" | jq 'length')
vercel_count=$(echo "$projects" | jq '[.[] | select(.type == "vercel")] | length')
swift_count=$(echo "$projects" | jq '[.[] | select(.type == "swift")] | length')
cli_count=$(echo "$projects" | jq '[.[] | select(.type == "cli")] | length')
git_count=$(echo "$projects" | jq '[.[] | select(.type == "git")] | length')

vercel_ready=0
vercel_building=0
vercel_queued=0
vercel_failed=0
swift_success=0
swift_failed=0
total_untracked=0
total_modified=0
total_issues=0
total_prs=0

# Quick git stats (sample first 20 projects for speed)
sample_count=0
while IFS= read -r path; do
  [[ -z "$path" ]] && continue
  [[ $sample_count -ge 20 ]] && break
  
  if [[ -d "$path/.git" ]]; then
    cd "$path" 2>/dev/null || continue
    u=$(git status --porcelain 2>/dev/null | grep -c "^??" || echo "0")
    m=$(git status --porcelain 2>/dev/null | grep -c "^ M\|^M " || echo "0")
    
    # Ensure numeric
    u=${u//[^0-9]/}
    m=${m//[^0-9]/}
    [[ -z "$u" ]] && u=0
    [[ -z "$m" ]] && m=0
    
    total_untracked=$((total_untracked + u))
    total_modified=$((total_modified + m))
    ((sample_count++)) || true
  fi
done < <(echo "$projects" | jq -r '.[].path')

if [[ "$OUTPUT_JSON" == true ]]; then
  echo "{\"total_projects\":$total_projects,\"vercel_count\":$vercel_count,\"swift_count\":$swift_count,\"cli_count\":$cli_count,\"git_count\":$git_count,\"vercel\":{\"ready\":$vercel_ready,\"building\":$vercel_building,\"queued\":$vercel_queued,\"failed\":$vercel_failed},\"swift\":{\"success\":$swift_success,\"failed\":$swift_failed},\"git\":{\"untracked\":$total_untracked,\"modified\":$total_modified},\"github\":{\"issues\":$total_issues,\"prs\":$total_prs}}"
else
  echo "󰐎 ${vercel_ready}◬ ${vercel_building}󱫟 ${vercel_queued}⨻ ${vercel_failed}  󰣪 ${swift_success}󰸞 ${swift_failed}✘   ${total_untracked} ${total_modified} ${total_issues} ${total_prs}  $total_projects projects"
fi
