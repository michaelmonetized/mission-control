#!/usr/bin/env bash
# mc-vl-status - Get Vercel deployment status for a project
# Usage: mc-vl-status <project_path> [--json]
# Output: JSON object with deployment state

set -euo pipefail

PROJECT_PATH="${1:-.}"
OUTPUT_JSON=false
[[ "${2:-}" == "--json" ]] && OUTPUT_JSON=true

cd "$PROJECT_PATH" 2>/dev/null || { echo '{"error":"invalid path"}'; exit 1; }

# Check if Vercel project
if [[ ! -d ".vercel" ]]; then
  [[ "$OUTPUT_JSON" == true ]] && echo '{"state":"none","url":""}' || echo "none	none"
  exit 0
fi

# Check if vercel available
if ! command -v vercel &>/dev/null; then
  [[ "$OUTPUT_JSON" == true ]] && echo '{"state":"unknown","url":""}' || echo "unknown	unknown"
  exit 0
fi

# Get latest deployment status via JSON
deployment=$(vercel ls --json -n 1 2>/dev/null || echo "[]")

if [[ "$deployment" == "[]" ]] || [[ -z "$deployment" ]]; then
  [[ "$OUTPUT_JSON" == true ]] && echo '{"state":"none","url":""}' || echo "none	"
  exit 0
fi

# Parse JSON
state=$(echo "$deployment" | jq -r '.[0].state // "unknown"' | tr '[:upper:]' '[:lower:]')
url=$(echo "$deployment" | jq -r '.[0].url // ""')

# Normalize state
case "$state" in
  ready) state="ready" ;;
  building) state="building" ;;
  queued) state="queued" ;;
  error|failed|cancelled) state="failed" ;;
  *) state="unknown" ;;
esac

if [[ "$OUTPUT_JSON" == true ]]; then
  echo "{\"state\":\"$state\",\"url\":\"$url\"}"
else
  echo -e "$state\t$url"
fi
