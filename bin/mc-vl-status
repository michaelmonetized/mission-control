#!/usr/bin/env bash
# mc-vl-status - Get Vercel deployment status for a project
# Usage: mc-vl-status <project_path> [--json]
# Output: JSON object with deployment state

set -euo pipefail

PROJECT_PATH="${1:-.}"
OUTPUT_JSON=false
[[ "${2:-}" == "--json" ]] && OUTPUT_JSON=true

cd "$PROJECT_PATH" 2>/dev/null || { echo '{"error":"invalid path"}'; exit 1; }

# Check if Vercel project
if [[ ! -d ".vercel" ]]; then
  [[ "$OUTPUT_JSON" == true ]] && echo '{"error":"not a vercel project"}' || echo "none	none"
  exit 0
fi

# Check if vercel/vl available
if ! command -v vercel &>/dev/null; then
  [[ "$OUTPUT_JSON" == true ]] && echo '{"error":"vercel not installed"}' || echo "unknown	unknown"
  exit 0
fi

# Get latest deployment status
deployment=$(vercel ls --limit 1 2>/dev/null | tail -n +2 | head -1 || echo "")

if [[ -z "$deployment" ]]; then
  [[ "$OUTPUT_JSON" == true ]] && echo '{"state":"none","url":""}' || echo "none	"
  exit 0
fi

# Parse deployment line
# Format: project-name url state age
state=$(echo "$deployment" | awk '{print $3}' | tr '[:upper:]' '[:lower:]')
url=$(echo "$deployment" | awk '{print $2}')

# Normalize state
case "$state" in
  ready) state="ready" ;;
  building) state="building" ;;
  queued) state="queued" ;;
  error|failed|cancelled) state="failed" ;;
  *) state="unknown" ;;
esac

if [[ "$OUTPUT_JSON" == true ]]; then
  cat <<EOF
{
  "state": "$state",
  "url": "$url"
}
EOF
else
  echo -e "$state\t$url"
fi
